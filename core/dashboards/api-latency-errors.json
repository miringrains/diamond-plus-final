{
  "dashboard": {
    "title": "Diamond District - API Latency & Errors",
    "uid": "dd-api-latency",
    "tags": ["diamond-district", "api", "performance"],
    "timezone": "browser",
    "schemaVersion": 16,
    "panels": [
      {
        "title": "API Request Rate",
        "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_server_duration_count{service_name=\"diamond-district\"}[5m])) by (http_route)",
            "legendFormat": "{{http_route}}"
          }
        ]
      },
      {
        "title": "API Error Rate",
        "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
        "type": "graph",
        "targets": [
          {
            "expr": "sum(rate(http_server_duration_count{service_name=\"diamond-district\",http_status_code=~\"4..|5..\"}[5m])) by (http_route, http_status_code)",
            "legendFormat": "{{http_route}} - {{http_status_code}}"
          }
        ],
        "alert": {
          "name": "High API Error Rate",
          "conditions": [
            {
              "evaluator": { "type": "gt", "params": [0.05] },
              "operator": { "type": "and" },
              "query": { "model": "A", "params": ["A", "5m", "now"] },
              "reducer": { "type": "avg" },
              "type": "query"
            }
          ],
          "message": "API error rate exceeds 5%"
        }
      },
      {
        "title": "API Latency - P95",
        "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(http_server_duration_bucket{service_name=\"diamond-district\"}[5m])) by (http_route, le))",
            "legendFormat": "{{http_route}} - p95"
          }
        ],
        "yaxes": [{ "format": "ms", "label": "Response Time" }]
      },
      {
        "title": "API Latency - P99",
        "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, sum(rate(http_server_duration_bucket{service_name=\"diamond-district\"}[5m])) by (http_route, le))",
            "legendFormat": "{{http_route}} - p99"
          }
        ],
        "yaxes": [{ "format": "ms", "label": "Response Time" }],
        "alert": {
          "name": "High API Latency",
          "conditions": [
            {
              "evaluator": { "type": "gt", "params": [1000] },
              "operator": { "type": "and" },
              "query": { "model": "A", "params": ["A", "5m", "now"] },
              "reducer": { "type": "avg" },
              "type": "query"
            }
          ],
          "message": "API P99 latency exceeds 1 second"
        }
      },
      {
        "title": "Top Slowest Endpoints",
        "gridPos": { "x": 0, "y": 16, "w": 12, "h": 8 },
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, avg by (http_route) (rate(http_server_duration_sum{service_name=\"diamond-district\"}[5m]) / rate(http_server_duration_count{service_name=\"diamond-district\"}[5m])))",
            "format": "table",
            "instant": true
          }
        ]
      },
      {
        "title": "Authentication Failures",
        "gridPos": { "x": 12, "y": 16, "w": 12, "h": 8 },
        "type": "stat",
        "targets": [
          {
            "expr": "sum(increase(span_events_total{service_name=\"diamond-district\",event_name=\"auth.failed\"}[1h]))",
            "legendFormat": "Auth Failures (1h)"
          }
        ],
        "thresholds": {
          "mode": "absolute",
          "steps": [
            { "color": "green", "value": null },
            { "color": "yellow", "value": 10 },
            { "color": "red", "value": 50 }
          ]
        }
      }
    ]
  }
}
